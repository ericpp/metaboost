<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Received Payment Metadata - MetaBoost</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            line-height: 1.6;
            color: #24292e;
            background: #f6f8fa;
            margin: 0;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1em;
            opacity: 0.9;
            font-weight: 400;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 0;
            min-height: calc(100vh - 120px);
        }

        .content {
            padding: 30px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f6f8fa;
            border-radius: 8px;
            border: 1px solid #e1e4e8;
        }

        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #d1d5da;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #0366d6;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: #586069;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #0366d6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: #0256cc;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #586069;
        }

        .error {
            background: #ffeaea;
            border: 1px solid #f85149;
            color: #d1242f;
            padding: 16px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .payment-card {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s;
        }

        .payment-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .payment-header {
            background: #f6f8fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e1e4e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-id {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 14px;
            color: #0366d6;
            font-weight: 500;
        }

        .payment-type {
            display: inline-block;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .payment-type.bitcoin-lightning {
            background: #f0f9ff;
            color: #0369a1;
            border: 1px solid #bae6fd;
        }

        .payment-type.monero {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .payment-body {
            padding: 20px;
        }

        .payment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-group {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 12px;
            color: #586069;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 14px;
            color: #24292e;
            word-break: break-all;
        }

        .detail-value.timestamp {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            font-size: 13px;
            color: #586069;
            font-weight: 500;
        }

        .jpt-section {
            margin-top: 20px;
        }

        .jpt-toggle {
            background: none;
            border: none;
            color: #0366d6;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 0;
            text-align: left;
        }

        .jpt-content {
            display: none;
            margin-top: 10px;
        }

        .jpt-content.show {
            display: block;
        }

        .jpt-raw {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 12px;
            color: #24292e;
            word-break: break-all;
            white-space: pre-wrap;
        }

        .jpt-decoded {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 16px;
            margin-top: 10px;
        }

        .jpt-decoded h4 {
            margin-bottom: 10px;
            color: #0369a1;
        }

        .jpt-decoded pre {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            padding: 12px;
            font-size: 12px;
            overflow-x: auto;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #586069;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #24292e;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .empty-state a {
            color: #0366d6;
            text-decoration: none;
            font-weight: 500;
        }

        .empty-state a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .pagination {
                justify-content: center;
            }

            .payment-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Received Payment Metadata</h1>
        <p class="subtitle">View and explore payment metadata stored in MetaBoost</p>
    </div>

    <div class="container">
        <div class="content">
            <div class="controls">
                <button class="refresh-btn" onclick="loadPayments()">Refresh</button>
                <div class="pagination">
                    <button id="prevBtn" onclick="previousPage()" disabled>Previous</button>
                    <span class="pagination-info" id="paginationInfo">Loading...</span>
                    <button id="nextBtn" onclick="nextPage()" disabled>Next</button>
                </div>
            </div>

            <div id="loading" class="loading" style="display: none;">
                Loading payment metadata...
            </div>

            <div id="error" class="error" style="display: none;"></div>

            <div id="paymentsContainer"></div>
        </div>
    </div>

    <script>
        let currentOffset = 0;
        const limit = 20;
        let totalCount = 0;

        async function loadPayments() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const container = document.getElementById('paymentsContainer');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            container.innerHTML = '';

            try {
                const response = await fetch(`/api/v1/payment-metadata/list?limit=${limit}&offset=${currentOffset}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                totalCount = data.pagination.total;

                updatePagination();
                displayPayments(data.data);

            } catch (err) {
                error.style.display = 'block';
                error.textContent = `Error loading payments: ${err.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function updatePagination() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const paginationInfo = document.getElementById('paginationInfo');

            prevBtn.disabled = currentOffset === 0;
            nextBtn.disabled = currentOffset + limit >= totalCount;

            const start = currentOffset + 1;
            const end = Math.min(currentOffset + limit, totalCount);
            paginationInfo.textContent = `Showing ${start}-${end} of ${totalCount} payments`;
        }

        function previousPage() {
            if (currentOffset > 0) {
                currentOffset = Math.max(0, currentOffset - limit);
                loadPayments();
            }
        }

        function nextPage() {
            if (currentOffset + limit < totalCount) {
                currentOffset += limit;
                loadPayments();
            }
        }

        function displayPayments(payments) {
            const container = document.getElementById('paymentsContainer');

            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No payments found</h3>
                        <p>No payment metadata has been stored yet.</p>
                        <p><a href="/">View API documentation</a> to learn how to create payment metadata.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = payments.map(payment => createPaymentCard(payment)).join('');
        }

        function createPaymentCard(payment) {
            const typeClass = payment.type.replace('bitcoin-', '');
            const jptId = `jpt-${payment.id}`;
            
            // Extract timestamps from JPT
            const timestamps = extractTimestamps(payment.jpt);
            
            return `
                <div class="payment-card">
                    <div class="payment-header">
                        <div class="payment-id">${payment.id}</div>
                        <span class="payment-type ${typeClass}">${payment.type}</span>
                    </div>
                    <div class="payment-body">
                        <div class="payment-details">
                            ${timestamps.issuedAt ? `
                                <div class="detail-group">
                                    <div class="detail-label">Issued At</div>
                                    <div class="detail-value timestamp">${formatTimestamp(timestamps.issuedAt)}</div>
                                </div>
                            ` : ''}
                            ${timestamps.resolveTime ? `
                                <div class="detail-group">
                                    <div class="detail-label">Payment Resolved</div>
                                    <div class="detail-value timestamp">${formatTimestamp(timestamps.resolveTime)}</div>
                                </div>
                            ` : ''}
                            ${timestamps.expiresAt ? `
                                <div class="detail-group">
                                    <div class="detail-label">Expires</div>
                                    <div class="detail-value timestamp">${formatTimestamp(timestamps.expiresAt)}</div>
                                </div>
                            ` : ''}
                            ${payment.podcastGuid ? `
                                <div class="detail-group">
                                    <div class="detail-label">Podcast GUID</div>
                                    <div class="detail-value">${payment.podcastGuid}</div>
                                </div>
                            ` : ''}
                            ${payment.rssItemGuid ? `
                                <div class="detail-group">
                                    <div class="detail-label">RSS Item GUID</div>
                                    <div class="detail-value">${payment.rssItemGuid}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="jpt-section">
                            <button class="jpt-toggle" onclick="toggleJPT('${jptId}')">
                                View JPT Details
                            </button>
                            <div class="jpt-content" id="${jptId}">
                                <div class="jpt-raw">${typeof payment.jpt === 'string' ? payment.jpt : JSON.stringify(payment.jpt, null, 2)}</div>
                                ${typeof payment.jpt === 'string' ? `
                                    <div class="jpt-decoded">
                                        <h4>Decoded JPT</h4>
                                        <pre id="decoded-${payment.id}">Decoding...</pre>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleJPT(jptId) {
            const content = document.getElementById(jptId);
            const toggle = content.previousElementSibling;
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.textContent = 'View JPT Details';
            } else {
                content.classList.add('show');
                toggle.textContent = 'Hide JPT Details';
                
                // Try to decode JPT if it's a string
                const paymentId = jptId.replace('jpt-', '');
                const decodedElement = document.getElementById(`decoded-${paymentId}`);
                if (decodedElement && decodedElement.textContent === 'Decoding...') {
                    decodeJPT(paymentId);
                }
            }
        }

        async function decodeJPT(paymentId) {
            try {
                const response = await fetch(`/api/v1/payment-metadata/${paymentId}`);
                if (response.ok) {
                    const payment = await response.json();
                    if (typeof payment.jpt === 'string') {
                        const decoded = parseJPT(payment.jpt);
                        const decodedElement = document.getElementById(`decoded-${paymentId}`);
                        if (decodedElement) {
                            decodedElement.textContent = JSON.stringify(decoded, null, 2);
                        }
                    }
                }
            } catch (error) {
                const decodedElement = document.getElementById(`decoded-${paymentId}`);
                if (decodedElement) {
                    decodedElement.textContent = `Error decoding JPT: ${error.message}`;
                }
            }
        }

        function extractTimestamps(jpt) {
            const timestamps = {};
            
            try {
                let payload;
                
                if (typeof jpt === 'string') {
                    const decoded = parseJPT(jpt);
                    payload = decoded.payload;
                } else if (jpt && jpt.payload) {
                    payload = jpt.payload;
                } else {
                    return timestamps;
                }
                
                // Extract standard JWT timestamps
                if (payload.iat) {
                    timestamps.issuedAt = payload.iat;
                }
                if (payload.exp) {
                    timestamps.expiresAt = payload.exp;
                }
                
                // Extract Lightning-specific timestamp
                if (payload.resolve_time) {
                    timestamps.resolveTime = payload.resolve_time;
                }
                
            } catch (error) {
                console.warn('Failed to extract timestamps from JPT:', error);
            }
            
            return timestamps;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            // Format relative time
            let relativeTime;
            if (diffDays > 0) {
                relativeTime = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else if (diffHours > 0) {
                relativeTime = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffMinutes > 0) {
                relativeTime = `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
            } else {
                relativeTime = 'Just now';
            }
            
            // Format absolute time
            const absoluteTime = date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            });
            
            return `${relativeTime} (${absoluteTime})`;
        }

        function parseJPT(jptString) {
            try {
                const parts = jptString.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JPT format');
                }

                const [headerStr, payloadStr, signature] = parts;
                
                const header = JSON.parse(atob(headerStr.replace(/-/g, '+').replace(/_/g, '/').padEnd(headerStr.length + (4 - headerStr.length % 4) % 4, '=')));
                const payload = JSON.parse(atob(payloadStr.replace(/-/g, '+').replace(/_/g, '/').padEnd(payloadStr.length + (4 - payloadStr.length % 4) % 4, '=')));

                return {
                    header,
                    payload,
                    signature
                };
            } catch (error) {
                throw new Error(`Failed to parse JPT: ${error.message}`);
            }
        }

        // Load payments on page load
        document.addEventListener('DOMContentLoaded', loadPayments);
    </script>
</body>
</html>
