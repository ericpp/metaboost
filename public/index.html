<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaBoost API Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            line-height: 1.6;
            color: #24292e;
            background: #f6f8fa;
            margin: 0;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 50px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header .version {
            font-size: 0.9em;
            opacity: 0.9;
            font-weight: 500;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 0;
        }

        .content {
            padding: 50px 50px 60px;
        }

        .meta-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
            padding: 25px;
            background: #f6f8fa;
            border-radius: 6px;
            border: 1px solid #e1e4e8;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 0.85em;
            color: #586069;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .meta-value {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.95em;
            color: #0366d6;
        }

        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
            background: #f6f8fa;
            border-radius: 6px;
            border: 1px solid #e1e4e8;
        }

        .nav-menu a {
            color: #0366d6;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .nav-menu a:hover {
            background: #0366d6;
            color: white;
            text-decoration: none;
        }

        h2 {
            font-size: 1.8em;
            margin-top: 50px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e4e8;
            color: #24292e;
            font-weight: 600;
            position: relative;
        }

        h2:first-of-type {
            margin-top: 0;
        }

        h2 .section-link {
            opacity: 0;
            color: #0366d6;
            text-decoration: none;
            font-size: 0.6em;
            margin-left: 8px;
            transition: opacity 0.2s;
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
        }

        h2:hover .section-link {
            opacity: 1;
        }

        h2:target {
            scroll-margin-top: 20px;
        }

        h3 {
            font-size: 1.3em;
            margin-top: 30px;
            margin-bottom: 15px;
            color: #24292e;
            font-weight: 600;
        }

        p {
            margin: 15px 0;
            color: #586069;
        }

        pre {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            font-size: 0.9em;
            line-height: 1.5;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }

        code {
            background: #f6f8fa;
            padding: 3px 6px;
            border-radius: 3px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }

        pre code {
            background: none;
            padding: 0;
            color: #24292e;
        }

        .endpoint {
            margin: 30px 0;
            padding: 25px;
            border-radius: 6px;
            background: white;
            border: 1px solid #e1e4e8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .method {
            display: inline-block;
            padding: 4px 12px;
            font-weight: 600;
            font-size: 0.85em;
            border-radius: 4px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .method.post { background: #28a745; }
        .method.get { background: #0366d6; }
        .method.put { background: #fb8500; }
        .method.delete { background: #d73a49; }

        .endpoint-path {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 1.1em;
            color: #24292e;
            font-weight: 600;
        }

        .endpoint h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .endpoint strong {
            display: block;
            margin-top: 20px;
            margin-bottom: 8px;
            color: #24292e;
            font-size: 0.95em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            overflow: hidden;
        }

        th, td {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid #e1e4e8;
        }

        th {
            background: #f6f8fa;
            font-weight: 600;
            color: #24292e;
            font-size: 0.9em;
        }

        tr:last-child td {
            border-bottom: none;
        }

        ul {
            margin: 15px 0;
            padding-left: 25px;
        }

        li {
            margin: 10px 0;
            color: #586069;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #0366d6;
            padding: 20px;
            margin: 25px 0;
            border-radius: 6px;
        }

        .info-box strong {
            color: #0366d6;
            display: block;
            margin-bottom: 8px;
        }

        a {
            color: #0366d6;
            text-decoration: none;
            font-weight: 500;
        }

        a:hover {
            text-decoration: underline;
        }

        .token-example {
            word-break: break-all;
            background: #fff8dc;
            padding: 16px;
            border: 1px solid #f1e05a;
            border-radius: 6px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.85em;
            margin: 20px 0;
            color: #6a4c00;
        }

        .resources {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .resource-card {
            padding: 20px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            background: #f6f8fa;
            transition: all 0.2s;
        }

        .resource-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .resource-card a {
            font-weight: 600;
            font-size: 1.05em;
        }

        footer {
            background: #24292e;
            color: #959da5;
            text-align: center;
            padding: 40px 20px;
            margin-top: 0;
        }

        footer p {
            margin: 8px 0;
            color: #959da5;
        }

        footer a {
            color: #58a6ff;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 30px 20px;
            }

            .endpoint {
                padding: 20px;
            }

            .meta-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MetaBoost API</h1>
    </div>

    <div class="container">
        <div class="content">

            <div class="nav-menu">
                <a href="#overview">Overview</a>
                <a href="#storage">Storage</a>
                <a href="#endpoints">Endpoints</a>
                <a href="#payment-types">Payment Types</a>
                <a href="#jpt-structure">JPT Structure</a>
                <a href="#building-jpt">Building JPTs</a>
                <a href="#examples">Examples</a>
                <a href="#security">Security</a>
                <a href="/payments.html" style="background: #28a745; color: white;">View Received Metadata</a>
            </div>

            <h2 id="overview">Overview<a href="#overview" class="section-link">ยง</a></h2>
        <p>
            MetaBoost is a RESTful API for storing and retrieving payment metadata using JSON Payment Tokens (JPTs).
            JPTs provide cryptographically-verifiable proof of payment across different blockchain networks.
        </p>

        <div class="info-box">
            <strong>JSON Payment Token (JPT) Structure:</strong><br>
            Format: <code>header.payload.signature</code> (base64url encoded)<br>
            Similar to JWT but designed for payment verification instead of authentication.
        </div>

        <h2 id="storage">Storage Backend<a href="#storage" class="section-link">ยง</a></h2>
        <ul>
            <li>Redis (key-value database)</li>
            <li>Primary key: <code>payment:{uuid}</code></li>
            <li>Index: <code>rss-index:{podcastGuid}:{rssItemGuid}</code> โ Set of payment IDs</li>
            <li>Environment variable: <code>REDIS_URL</code></li>
        </ul>

        <h2 id="endpoints">API Endpoints<a href="#endpoints" class="section-link">ยง</a></h2>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="method post">POST</span>
                <span class="endpoint-path">/payment-metadata</span>
            </div>
            
            <h3>Create Payment Metadata</h3>
            <p>Store a new JPT with optional RSS item associations.</p>
            
            <strong>Request Body:</strong>
            <pre>{
  "jpt": "eyJhbGci...",           // string or object (JPT)
  "type": "bitcoin-lightning",    // "bitcoin-lightning" | "monero"
  "podcastGuid": "uuid",          // optional
  "rssItemGuid": "string"         // optional
}</pre>

            <strong>Response (200):</strong>
            <pre>{
  "id": "uuid",
  "updateToken": "uuid"
}</pre>

            <strong>Errors:</strong> 400 (Invalid input), 422 (Validation exception)
        </div>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="method get">GET</span>
                <span class="endpoint-path">/payment-metadata/{id}</span>
            </div>
            
            <h3>Get Payment Metadata by ID</h3>
            <p>Retrieve a specific payment metadata entry.</p>
            
            <strong>Path Parameters:</strong>
            <ul>
                <li><code>id</code> - UUID of payment metadata</li>
            </ul>

            <strong>Response (200):</strong>
            <pre>{
  "id": "uuid",
  "jpt": "eyJhbGci...",
  "type": "bitcoin-lightning",
  "podcastGuid": "uuid",
  "rssItemGuid": "string"
}</pre>

            <strong>Errors:</strong> 400 (Invalid ID), 404 (Not found)
        </div>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="method get">GET</span>
                <span class="endpoint-path">/payment-metadata/findByRSSItem</span>
            </div>
            
            <h3>Find Payment Metadata by RSS Item</h3>
            <p>Query all payments associated with a podcast episode.</p>
            
            <strong>Query Parameters:</strong>
            <ul>
                <li><code>podcastGuid</code> - UUID from RSS &lt;podcast:guid&gt; tag (required)</li>
                <li><code>rssItemGuid</code> - RSS item GUID (required)</li>
            </ul>

            <strong>Response (200):</strong> Array of PaymentMetadata objects
            
            <strong>Errors:</strong> 400 (Missing params), 404 (No results)
        </div>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="method put">PUT</span>
                <span class="endpoint-path">/payment-metadata</span>
            </div>
            
            <h3>Update Payment Metadata</h3>
            <p>Update existing payment metadata. Requires updateToken for authorization.</p>
            
            <strong>Query Parameters:</strong>
            <ul>
                <li><code>updateToken</code> - UUID from create/update response (required)</li>
            </ul>

            <strong>Request Body:</strong>
            <pre>{
  "id": "uuid",
  "updateToken": "uuid",
  "jpt": "eyJhbGci...",
  "type": "bitcoin-lightning"
}</pre>

            <strong>Response (200):</strong> New id and updateToken
            
            <strong>Errors:</strong> 400 (Invalid token), 404 (Not found), 422 (Validation error)
        </div>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="method delete">DELETE</span>
                <span class="endpoint-path">/payment-metadata/{id}</span>
            </div>
            
            <h3>Delete Payment Metadata</h3>
            <p>Permanently remove payment metadata. Requires updateToken for authorization.</p>
            
            <strong>Path Parameters:</strong>
            <ul>
                <li><code>id</code> - UUID of payment metadata</li>
            </ul>

            <strong>Query Parameters:</strong>
            <ul>
                <li><code>updateToken</code> - UUID from create/update response (required)</li>
            </ul>

            <strong>Response (201):</strong> Success message
            
            <strong>Errors:</strong> 400 (Invalid ID/token), 404 (Not found)
        </div>

        <h2 id="payment-types">Payment Types<a href="#payment-types" class="section-link">ยง</a></h2>
        <table>
            <tr>
                <th>Type</th>
                <th>Description</th>
                <th>JPT Algorithm</th>
            </tr>
            <tr>
                <td><code>bitcoin-lightning</code></td>
                <td>Bitcoin Lightning Network</td>
                <td>lightning-keysend</td>
            </tr>
            <tr>
                <td><code>monero</code></td>
                <td>Monero cryptocurrency</td>
                <td>monero-transaction</td>
            </tr>
        </table>

        <h2 id="jpt-structure">JPT Structure<a href="#jpt-structure" class="section-link">ยง</a></h2>
        
        <h3>Header</h3>
        <pre>{
  "alg": "lightning-keysend",  // Payment method identifier
  "typ": "JPT"                 // Token type
}</pre>

        <h3>Payload (Lightning Example)</h3>
        <pre>{
  "aud": "receiver_pubkey",       // Receiver's Lightning public key
  "iss": "sender_pubkey",         // Sender's Lightning public key
  "iat": 1647906111,              // Issued at (unix timestamp)
  "exp": 1647992511,              // Expiration (optional)
  "resolve_time": 1647891435,     // Payment resolved time
  "amt_paid_msat": "100000",      // Amount in millisatoshis
  "payment_hash": "hex_string",   // Payment hash for verification
  "preimage": "hex_string"        // Payment preimage (optional)
}</pre>

        <h3>Complete JPT Example</h3>
        <div class="token-example">
eyJhbGciOiJsaWdodG5pbmcta2V5c2VuZCIsInR5cCI6IkpQVCJ9.eyJhdWQiOiIwMzJmNGZmYmJhZmZmYmU1MTcyNmFkM2MxNjRhM2QwZDM3ZWMyN2JjNjdiMjlhMTU5YjBmNDlhZThhYzIxYjg1MDgiLCJpc3MiOiIwMmI2NmQ3Y2FhZTFhY2I1MWE5NWUwMzZmYzEyYjFlNjgzN2Q5MTQzMTQxZmNmZjUyMDg3NmIwNGI5ZDgyZjM2ZDEiLCJpYXQiOjE2NDc5MDYxMTEsInJlc29sdmVfdGltZSI6MTY0Nzg5MTQzNSwiYW10X3BhaWRfbXNhdCI6IjEwMDAwMCIsInBheW1lbnRfaGFzaCI6ImQ4N2JkZWU2ZjllNGQzZjAwZjA5YzlhZDI5ZDYxZDM0NDA1YmI0Y2ZlNjRmYzA0OTBiMjZlNTEwNWQ3YWNlYTcifQ.d6o1uw865o1qpoubc5o1d9zmtooahoqkegokjogpoqt3zdquau6m1z1dyqcyypehz8i8k7bn5bfnm4sckrd7679nmqbmnk1559jx937r
        </div>

        <h2 id="building-jpt">Building JPTs<a href="#building-jpt" class="section-link">ยง</a></h2>
        
        <p>Creating a JPT involves three steps: building the header, creating the payload, and generating the signature.</p>

        <h3>Step 1: Create Header</h3>
        <pre>const header = {
  "alg": "lightning-keysend",  // or "monero-transaction", etc.
  "typ": "JPT"
};</pre>

        <h3>Step 2: Build Payload</h3>
        <p>Payload contains payment-specific information. Here are examples for different payment types:</p>

        <h4>Lightning Network JPT</h4>
        <pre>const payload = {
  "aud": "032f4ffbbafffbe51726ad3c164a3d0d37ec27bc67b29a159b0f49ae8ac21b8508", // Receiver pubkey
  "iss": "02b66d7caae1acb51a95e036fc12b1e6837d9143141fcff520876b04b9d82f36d1", // Sender pubkey
  "iat": Math.floor(Date.now() / 1000),                    // Current timestamp
  "exp": Math.floor(Date.now() / 1000) + 86400,           // 24 hours from now
  "resolve_time": 1647891435,                              // When payment was resolved
  "amt_paid_msat": "100000",                              // Amount in millisatoshis
  "payment_hash": "d87bdee6f9e4d3f00f09c9ad29d61d34405bb4cfe64fc0490b26e5105d7acea7",
  "preimage": "optional_preimage_hex"                     // Optional
};</pre>

        <h4>Monero JPT</h4>
        <pre>const payload = {
  "aud": "recipient_address",                              // Recipient Monero address
  "iss": "sender_address",                                // Sender Monero address
  "iat": Math.floor(Date.now() / 1000),                   // Current timestamp
  "exp": Math.floor(Date.now() / 1000) + 86400,          // 24 hours from now
  "tx_hash": "a7ea7d5015e5620b49c04fe6cfb45b40341d6d92adc9090ff0d3e4f9e6ed7bd8",
  "tx_key": "transaction_key_for_verification",
  "amount": "1000000000000",                              // Amount in atomic units
  "confirmations": 10                                      // Number of confirmations
};</pre>

        <h3>Step 3: Generate Signature</h3>
        <p>The signature is created by signing the concatenated header and payload with the sender's private key.</p>

        <h4>JavaScript Example</h4>
        <pre>// 1. Encode header and payload to base64url
const headerB64 = base64urlEncode(JSON.stringify(header));
const payloadB64 = base64urlEncode(JSON.stringify(payload));

// 2. Create message to sign
const message = `${headerB64}.${payloadB64}`;

// 3. Sign with sender's private key (method depends on payment network)
const signature = await signMessage(message, senderPrivateKey);

// 4. Create final JPT
const jpt = `${headerB64}.${payloadB64}.${signature}`;</pre>

        <h4>Lightning Network Example (Node.js)</h4>
        <pre>const { createHash, createSign } = require('crypto');

// Using Lightning node's signing capability
async function createLightningJPT(paymentData) {
  const header = {
    "alg": "lightning-keysend",
    "typ": "JPT"
  };
  
  const payload = {
    "aud": paymentData.receiverPubkey,
    "iss": paymentData.senderPubkey,
    "iat": Math.floor(Date.now() / 1000),
    "resolve_time": paymentData.resolveTime,
    "amt_paid_msat": paymentData.amountMsat,
    "payment_hash": paymentData.paymentHash
  };
  
  // Encode to base64url
  const headerB64 = base64urlEncode(JSON.stringify(header));
  const payloadB64 = base64urlEncode(JSON.stringify(payload));
  const message = `${headerB64}.${payloadB64}`;
  
  // Sign with Lightning node (this would use your Lightning node's API)
  const signature = await lightningNode.signMessage(message);
  
  return `${headerB64}.${payloadB64}.${signature}`;
}</pre>

        <h3>Base64URL Encoding</h3>
        <p>JPTs use base64url encoding (URL-safe base64 without padding):</p>
        <pre>function base64urlEncode(str) {
  return Buffer.from(str)
    .toString('base64')
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
}

function base64urlDecode(str) {
  const base64 = str.replace(/-/g, '+').replace(/_/g, '/');
  const padding = '='.repeat((4 - (base64.length % 4)) % 4);
  return Buffer.from(base64 + padding, 'base64').toString('utf8');
}</pre>

        <h3>Validation Requirements</h3>
        <ul>
            <li><strong>Header:</strong> Must contain <code>alg</code> and <code>typ: "JPT"</code></li>
            <li><strong>Payload:</strong> Must include <code>iat</code> (issued at timestamp)</li>
            <li><strong>Expiration:</strong> If <code>exp</code> is present, it must be in the future</li>
            <li><strong>Payment-specific:</strong> Required fields vary by payment type</li>
            <li><strong>Signature:</strong> Must be valid for the message and sender's public key</li>
        </ul>

        <div class="info-box">
            <strong>Important:</strong> Always verify signatures using the appropriate payment network tools 
            (Lightning node, Monero wallet, etc.) before trusting a JPT. The MetaBoost API only validates 
            structure, not cryptographic authenticity.
        </div>

        <h2 id="examples">Example Usage<a href="#examples" class="section-link">ยง</a></h2>

        <h3>Create Payment Metadata</h3>
        <pre>curl -X POST /payment-metadata \
  -H "Content-Type: application/json" \
  -d '{
    "jpt": "eyJhbGci...",
    "type": "bitcoin-lightning",
    "podcastGuid": "123e4567-e89b-12d3-a456-426614174000",
    "rssItemGuid": "episode-001"
  }'</pre>

        <h3>Query by RSS Item</h3>
        <pre>curl "/payment-metadata/findByRSSItem?podcastGuid=123e4567-e89b-12d3-a456-426614174000&rssItemGuid=episode-001"</pre>

        <h3>Get by ID</h3>
        <pre>curl "/payment-metadata/0ce03790-b2b4-47da-9401-5e587d1deac8"</pre>

        <h3>Update Metadata</h3>
        <pre>curl -X PUT "/payment-metadata?updateToken=uuid" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "uuid",
    "updateToken": "uuid",
    "jpt": "eyJhbGci...",
    "type": "bitcoin-lightning"
  }'</pre>

        <h3>Delete Metadata</h3>
        <pre>curl -X DELETE "/payment-metadata/uuid?updateToken=uuid"</pre>

        <h2 id="security">Security Notes<a href="#security" class="section-link">ยง</a></h2>
        <ul>
            <li>Signature verification must be done by payment network (Lightning node, etc.)</li>
            <li>updateToken required for all write/delete operations</li>
            <li>updateToken rotates on each successful update</li>
            <li>All UUIDs validated for proper format</li>
            <li>JPT expiration checked if <code>exp</code> claim present</li>
        </ul>

        </div>
    </div>

    <footer>
        <p>Based on the <a href="https://github.com/Podcastindex-org/podcast-namespace/discussions/676">podcast:metaBoost</a> proposal by Alecks Gates</p>
    </footer>
</body>
</html>

